# Makefile para PG Analytics OpenTelemetry Collector

.PHONY: build run test clean docker-build docker-run

# VariÃ¡veis
APP_NAME=otel-collector
DOCKER_IMAGE=pganalytics/otel-collector:latest
PORT=9188

# Build local
build:
	@echo "ğŸ”¨ Building OpenTelemetry collector..."
	go mod tidy
	go build -o $(APP_NAME) .
	@echo "âœ… Build completo!"

# Executar localmente
run: build
	@echo "ğŸš€ Iniciando coletor..."
	DATABASE_URL="postgres://postgres:postgres@localhost:5432/pganalytics?sslmode=disable" \
	PORT=$(PORT) \
	./$(APP_NAME)

# Testes
test:
	@echo "ğŸ§ª Executando testes..."
	go test ./...

# Limpar binÃ¡rios
clean:
	@echo "ğŸ§¹ Limpando..."
	rm -f $(APP_NAME)
	go clean

# Build Docker
docker-build:
	@echo "ğŸ³ Building Docker image..."
	docker build -t $(DOCKER_IMAGE) .
	@echo "âœ… Docker image criada: $(DOCKER_IMAGE)"

# Executar via Docker
docker-run: docker-build
	@echo "ğŸš€ Executando via Docker..."
	docker run -d \
		--name pganalytics-otel \
		--network pganalytics_default \
		-p $(PORT):$(PORT) \
		-e DATABASE_URL="postgres://postgres:postgres@postgres:5432/pganalytics?sslmode=disable" \
		$(DOCKER_IMAGE)
	@echo "âœ… Coletor rodando na porta $(PORT)"

# Parar container
docker-stop:
	@echo "â¹ï¸  Parando coletor..."
	docker stop pganalytics-otel || true
	docker rm pganalytics-otel || true

# Logs do container
docker-logs:
	docker logs -f pganalytics-otel

# Deploy completo
deploy: docker-build docker-stop docker-run
	@echo "ğŸ¯ Deploy completo!"
	@echo "ğŸ“Š MÃ©tricas: http://localhost:$(PORT)/metrics"
	@echo "â¤ï¸  Health: http://localhost:$(PORT)/health"
	@echo "ğŸŒ Slow Queries: http://localhost:$(PORT)/slow-queries"
	@echo "ğŸ”— ConexÃµes: http://localhost:$(PORT)/connections"

# Verificar status
status:
	@echo "ğŸ“Š Status do coletor:"
	@curl -s http://localhost:$(PORT)/health | jq . || echo "âŒ Coletor nÃ£o estÃ¡ rodando"
